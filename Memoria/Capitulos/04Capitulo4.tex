%---------------------------------------------------------------------
%
%                          Capítulo 4
%
%---------------------------------------------------------------------

\chapter{Análisis del Contenido Afectivo de un Texto}

\begin{resumen}
En este capítulo se explicarán los servicios web que se han desarrollado con el fin de analizar el contenido afectivo de un texto.
Primero, en la sección 4.1, se explica la base sobre la que trabajaran todos los servicios. En la sección 4.2, se presentarán los servicios orientados a identificar las emociones predominantes en una palabra concreta. Después, en la sección 4.3, se explica como el análisis de la palabra se aplica a determinar la emoción de una frase entera para finalmente, en la sección 4.4, aplicar todo al análisis de un texto arbitrario completo.
\end{resumen}

%-------------------------------------------------------------------
\section{Base para los servicios web}
%-------------------------------------------------------------------
\label{cap4:sec:base}

Como ya se comentó en la sección 3.1, para el desarrollo de este trabajo se utilizará un diccionario afectivo en español. Este diccionario, inicialmente en formato Excel, ha sido convertido a un fichero CSV para que resulte más sencillo obtener los datos. 

Los datos estarán almacenados en el servidor Django.
\begin{itemize}
	\item \textbf{Modelo: } Los campos que tiene el modelo para cada palabra, son: la propia palabra, el lema de esta y el porcentaje de certeza de cada una de las emociones básicas y la neutralidad. Cada una de las palabras que tenemos recogidas se encapsulan en este modelo para ser almacenadas en el servidor.
	
	\lstdefinestyle{python}{language=Python,}
	
	\begin{lstlisting}[style=python]
class Palabra(models.Model):
    palabra = models.CharField(max_length = 30)
    lexema = models.CharField(max_length = 30)
    porcenta    jes = models.CharField(validators=
        [validate_comma_separated_integer_list], max_length = 100)
			
    def __str__(self):
        return self.palabra
					
    class Meta:
        ordering = ('palabra')
	\end{lstlisting}
	\item \textbf{Consultas: } Se realizarán mediante declaración de clases ``vista'' según las funcionalidades que requiera cada uno de los servicios web que vamos a desarrollar. Inicialmente disponemos de una vista general (Figura \ref{fig:vista_general}) que muestra la lista entera de palabras almacenadas y una vista detalle (Figura \ref{fig:vista_det}) para cada una de ellas.
\end{itemize}

\figura{Bitmap/Capitulo4/vista_general}{width=.6\textwidth}{fig:vista_general}{Vista general de la lista de palabras.}
\figura{Bitmap/Capitulo4/vista_detalle}{width=.4\textwidth}{fig:vista_det}{Vista detalle de la palabra ``Alegre''.}


Una vez que se tiene el servidor y todo el código necesario para el funcionamiento de los servicios web se procede a publicar las palabras que recoge nuestro diccionario. Para ello se ha desarrollado un programa en \textit{Python} cuya función es leer el fichero CSV, interpretar cada una de sus líneas y almacenar la información que obtiene en la base de datos del servidor. Una vez que todas las palabras estén subidas ya se pueden realizar las consultas necesarias.

%-------------------------------------------------------------------
\section{Análisis afectivo de una palabra}
%-------------------------------------------------------------------
\label{cap4:sec:palabra}

Hemos implementado tres servicios web diferentes para mostrar la carga afectiva de una palabra, dependiendo de la información buscada en cada momento.

\subsection{Servicio web porcentajes de una palabra}
Dada una palabra, este servicio nos devuelve la información respectiva a los porcentajes de cada emoción que posee. Para ello se realiza una petición \textbf{GET} al servidor, y se devuelve el resultado en formato JSON al usuario.

Como entrada tendríamos la palabra de la cual queremos conocer sus emociones; existirán dos posibilidades, bien que la palabra esté en nuestro diccionario, por lo que la salida sería el porcentaje de cada emoción (Figura \ref{fig:porcentajes}), o bien que la palabra no exista en nuestro diccionario, que devolverá un mensaje 404 de ``NOT FOUND'' (Figura \ref{fig:notfound}).

\figura{Bitmap/Capitulo4/porcentajes}{width=.4\textwidth}{fig:porcentajes}{Respuesta al buscar los porcentajes de la palabra ``alegre''.}
	
\figura{Bitmap/Capitulo4/no_encontrada}{width=.4\textwidth}{fig:notfound}{Respuesta al buscar los porcentajes de una palabra que no está en el diccionario.}


\subsection{Servicio web emoción consensuada de una palabra}
Dada una palabra, este servicio nos devuelve a través de una petición \textbf{GET} al servidor, si la palabra tiene o no emoción consensuada y en caso de tenerla cuál.  Hablamos de emoción consensuada cuando el grado de certeza que se tiene de una de sus emociones es 1, es decir, el porcentaje para dicha emoción es 100. 

Como entrada tendríamos la palabra de la cual queremos conocer su emoción consensuada, mientras que la salida será la emoción consensuada en caso de tenerla (Figura \ref{fig:consensuada}) o un mensaje de que no la tiene (Figura \ref{fig:noconsensuada}).

\figura{Bitmap/Capitulo4/consensuada}{width=.4\textwidth}{fig:consensuada}{Respuesta al encontrar la emoción consensuada.}

\figura{Bitmap/Capitulo4/no_consensuada}{width=.4\textwidth}{fig:noconsensuada}{Respuesta si la palabra no tiene emoción consensuada.}

\subsection{Servicio web emoción mayoritaria de una palabra}
De nuevo, dada una palabra el servicio nos devuelve, recibiendo una petición \textbf{GET} en el servidor, la emoción mayoritaria de una palabra. Hablamos de emoción mayoritaria cuando el porcentaje de certeza de una emoción es mayor al del resto de emociones.

Como entrada tendríamos la palabra de la cual queremos conocer su emoción mayoritaria, mientras que la salida será la emoción mayoritaria (Figura \ref{fig:mayoritaria}), o mayoritarias (en caso de que haya dos con el mismo porcentaje) (Figura \ref{fig:mayoritarias}).

\figura{Bitmap/Capitulo4/mayoritaria}{width=.4\textwidth}{fig:mayoritaria}{Respuesta al encontrar la emoción mayoritaria.}
\figura{Bitmap/Capitulo4/mayoritarias}{width=.4\textwidth}{fig:mayoritarias}{Respuesta si hay dos emociones mayoritarias.}

%-------------------------------------------------------------------
\section{Análisis afectivo de una frase}
%-------------------------------------------------------------------
\label{cap4:sec:frase}

El anális emocional de una frase se sustenta en los servicios web desarrollados para hallar la carga afectiva de las palabras. Dividiremos la frase en las palabras que la forman y procesaremos cada una de estas utilizando las herramientas comentadas en el apartado 3.5 para obtener una lista de palabras candidatas acompañadas de sus lemas. Para cada una de las palabras de la lista obtenemos su información emocional mediante los servicios web explicados en el apartado anterior y, combinando los resultados obtenidos, podemos mostrar la carga afectiva de toda la frase. 

Partimos de la base de que cualquier frase es, de primeras, carente de emoción así que si no contiene ningún palabra emocional el resultado será que es una frase 100\% neutral (Figura \ref{fig:analisis_neutral}). Para el resto de frases, además de los resultados del análisis emocional devolvemos la lista de palabras que nos han llevado a ellos.

\figura{Bitmap/Capitulo4/analisis_neutral}{width=.5\textwidth}{fig:analisis_neutral}{Análisis de una frase sin palabras emocionales.}

\subsection{Porcentajes de una frase}
Los porcentajes de cada emoción para una frase se obtienen haciendo una media con los porcentajes de las palabras emocionales que aparecen en ella. Por ejemplo, si la frase es: \textit{Estoy alegre y feliz.}, las palabras emocionales son ``alegre'' y ``feliz'' y se haría una media entre las dos para todos los porcentajes. En este caso ambas son 100\% alegres y 0\% el resto de emociones, así que el resultado sería que la frase es 100\% alegre (Figura \ref{fig:analisis_alegre}). Si la frase, en cambio, es: \textit{Estoy alegre y triste}, como ``alegre'' es 100\% alegre y ``triste'' es 100\% triste, la frase será 50\% de cada una de estas emociones (Figura \ref{fig:analisis_bipolar}).

\figura{Bitmap/Capitulo4/analisis_alegre}{width=.5\textwidth}{fig:analisis_alegre}{Análisis de una frase con palabras alegres.}
\figura{Bitmap/Capitulo4/analisis_bipolar}{width=.5\textwidth}{fig:analisis_bipolar}{Análisis de una frase con palabras de varias emociones.}

La media que realizamos es ponderada, dando más peso a los verbos ya que estos son el núcleo de la frase. Concretamente, los verbos tienen el doble de peso que el resto de palabras, antes de sumar sus porcentajes con el resto para hacer la media los multiplicamos por dos. Si alguna de las palabras emocionales de la lista no están en nuestro diccionario y su lema no coincide con el de alguna palabra que sí lo esté la palabra se descarta. 

\subsection{Emoción mayoritaria de una frase}
Para hallar la emoción mayoritaria de una frase se cuentan las apariciones de una emoción entre las palabras emocionales como mayoritaria y se hace una media con los porcentajes de todas estas apariciones, dando más importancia a los porcentajes de los verbos, de la misma manera que al calcular los porcentajes. Una vez que se tienen los porcentajes definitivos para cada emoción se comparan para hallar el mayor y la emoción a la que corresponde será la mayoritaria de la frase. 
%-------------------------------------------------------------------
\section{Análisis afectivo de un texto}
%-------------------------------------------------------------------
\label{cap4:sec:texto}

Analizar un texto consiste, básicamente, en partirlo en frases y obtener la carga afectiva de cada una de ellas. 

Las frases se obtienen partiendo el texto cada vez que se encuentra un "`."'. Una vez que se tienen las frases del texto hay que analizarlas porque pueden conter subfrases, las frases interrogativas o exclamativas no acaban con un punto por lo que estarán incluidas en otra frase. Se parte, por lo tanto, cada frase en sus subfrases (si las tiene) y a cada subfrase se le asigna un tipo: enunciativa, interrogativa o exclamativa. Según el tipo de la frase esta tendrá más o menos peso. Las exclamativas tienen el doble de peso que las enunciativas mientras que las interrogativas tienen la mitad.

Las operaciones realizadas durante el análisis son prácticamente las mismas que para analizar una frase: medias ponderadas para hallar los porcentajes y la emoción mayoritaria a partir de la información devuelta por cada frase teniendo en cuenta los pesos de las subfrases.
% Variable local para emacs, para  que encuentre el fichero maestro de
% compilación y funcionen mejor algunas teclas rápidas de AucTeX
%%%
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../Tesis.tex"
%%% End:
